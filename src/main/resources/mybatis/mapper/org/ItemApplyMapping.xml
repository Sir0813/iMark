<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dm.user.mapper.ItemApplyMapper">
    <resultMap id="BaseResultMap" type="com.dm.user.entity.ItemApply">
        <id column="applyid" jdbcType="INTEGER" property="applyid"/>
        <result column="apply_no" jdbcType="VARCHAR" property="applyNo"/>
        <result column="itemid" jdbcType="INTEGER" property="itemid"/>
        <result column="userid" jdbcType="INTEGER" property="userid"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="describe" jdbcType="VARCHAR" property="describe"/>
        <result column="certid" jdbcType="INTEGER" property="certid"/>
        <result column="created_date" jdbcType="TIMESTAMP" property="createdDate"/>
        <result column="submit_date" jdbcType="TIMESTAMP" property="submitDate"/>
        <result column="item_value" jdbcType="DECIMAL" property="itemValue"/>
        <result column="price" jdbcType="DECIMAL" property="price"/>
        <result column="wf_instance_id" jdbcType="VARCHAR" property="wfInstanceId"/>
        <result column="handle_created_date" jdbcType="TIMESTAMP" property="handleCreatedDate"/>
        <result column="handle_userid" jdbcType="INTEGER" property="handleUserid"/>
    </resultMap>
    <sql id="Base_Column_List">
    applyid, apply_no, itemid, userid, `status`, `describe`, certid, created_date, submit_date,
    item_value, price, wf_instance_id, handle_created_date, handle_userid
  </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from biz_item_apply
        where applyid = #{applyid,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from biz_item_apply
    where applyid = #{applyid,jdbcType=INTEGER}
  </delete>
    <insert id="insertSelective" parameterType="com.dm.user.entity.ItemApply" useGeneratedKeys="true"
            keyProperty="applyid">
        insert into biz_item_apply
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="applyNo != null">
                apply_no,
            </if>
            <if test="itemid != null">
                itemid,
            </if>
            <if test="userid != null">
                userid,
            </if>
            <if test="status != null">
                `status`,
            </if>
            <if test="describe != null">
                `describe`,
            </if>
            <if test="certid != null">
                certid,
            </if>
            <if test="createdDate != null">
                created_date,
            </if>
            <if test="submitDate != null">
                submit_date,
            </if>
            <if test="itemValue != null">
                item_value,
            </if>
            <if test="price != null">
                price,
            </if>
            <if test="wfInstanceId != null">
                wf_instance_id,
            </if>
            <if test="handleCreatedDate != null">
                handle_created_date,
            </if>
            <if test="handleUserid != null">
                handle_userid,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="applyNo != null">
                #{applyNo,jdbcType=VARCHAR},
            </if>
            <if test="itemid != null">
                #{itemid,jdbcType=INTEGER},
            </if>
            <if test="userid != null">
                #{userid,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="describe != null">
                #{describe,jdbcType=VARCHAR},
            </if>
            <if test="certid != null">
                #{certid,jdbcType=INTEGER},
            </if>
            <if test="createdDate != null">
                #{createdDate,jdbcType=TIMESTAMP},
            </if>
            <if test="submitDate != null">
                #{submitDate,jdbcType=TIMESTAMP},
            </if>
            <if test="itemValue != null">
                #{itemValue,jdbcType=DECIMAL},
            </if>
            <if test="price != null">
                #{price,jdbcType=DECIMAL},
            </if>
            <if test="wfInstanceId != null">
                #{wf_instance_id,jdbcType=VARCHAR},
            </if>
            <if test="handleCreatedDate != null">
                #{handle_created_date,jdbcType=TIMESTAMP},
            </if>
            <if test="handleUserid != null">
                #{handle_userid,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.dm.user.entity.ItemApply">
        update biz_item_apply
        <set>
            <if test="applyNo != null">
                apply_no = #{applyNo,jdbcType=VARCHAR},
            </if>
            <if test="itemid != null">
                itemid = #{itemid,jdbcType=INTEGER},
            </if>
            <if test="userid != null">
                userid = #{userid,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                `status` = #{status,jdbcType=INTEGER},
            </if>
            <if test="describe != null">
                `describe` = #{describe,jdbcType=VARCHAR},
            </if>
            <if test="certid != null">
                certid = #{certid,jdbcType=INTEGER},
            </if>
            <if test="createdDate != null">
                created_date = #{createdDate,jdbcType=TIMESTAMP},
            </if>
            <if test="submitDate != null">
                submit_date = #{submitDate,jdbcType=TIMESTAMP},
            </if>
            <if test="itemValue != null">
                item_value = #{itemValue,jdbcType=DECIMAL},
            </if>
            <if test="price != null">
                price = #{price,jdbcType=DECIMAL},
            </if>
            <if test="wfInstanceId != null">
                wf_instance_id = #{wfInstanceId,jdbcType=VARCHAR},
            </if>
            <if test="handleCreatedDate != null">
                handle_created_date = #{handleCreatedDate,jdbcType=TIMESTAMP},
            </if>
            <if test="handleUserid != null">
                handle_userid = #{handleUserid,jdbcType=INTEGER},
            </if>
        </set>
        where applyid = #{applyid,jdbcType=INTEGER}
    </update>
    <select id="list" parameterType="java.lang.Integer" resultType="com.dm.user.entity.ItemApply">
        SELECT
	    itemapply.applyid AS applyid,
	    itemapply.apply_no AS applyNo,
    	itemapply.certid AS certid,
    	itemapply.created_date AS createdDate,
    	itemapply.`describe` AS `describe`,
	    itemapply.itemid AS itemid,
	    itemapply.item_value AS itemValue,
	    itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName
        FROM
            biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        WHERE
            userid = #{userid,jdbcType=INTEGER}
        ORDER BY
	    createdDate DESC
    </select>
    <select id="pendList" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date as submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName
        FROM biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        where 1 = 1
        <if test="itemId != null and itemId != '' ">
            and itemapply.itemid = #{itemId}
        </if>
        <if test="itemIds != null">
            and itemapply.itemid in
            <foreach collection="itemIds" item="itemId" open="(" close=")" separator=",">
                #{itemId}
            </foreach>
        </if>
        and itemapply.`status` = #{status}
        and itemapply.handle_userid = 0
        and itemapply.handle_created_date is null
        order by createdDate desc
    </select>
    <select id="pendReview" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date as submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName
        FROM biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        where 1=1
        <if test="itemId != null and itemId != '' ">
            and itemapply.itemid = #{itemId}
        </if>
        <if test="itemIds != null">
            and itemapply.itemid in
            <foreach collection="itemIds" item="itemId" open="(" close=")" separator=",">
                #{itemId}
            </foreach>
        </if>
        <choose>
            <when test="status == 2">
                and itemapply.`status` = #{status}
            </when>
            <otherwise>
                and itemapply.`status` in
                <foreach collection="status" item="state" open="(" close=")" separator=",">
                    #{state}
                </foreach>
            </otherwise>
        </choose>
        and itemapply.handle_userid = #{userId}
        order by createdDate desc
    </select>
    <select id="selectWaitList" parameterType="java.lang.String" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date AS submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName
        FROM
        biz_item_apply AS itemapply
        INNER JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        WHERE
        itemapply.wf_instance_id IN (
        SELECT
        id
        FROM
        wf_instance
        WHERE
        nodeid IN (
        SELECT
        id
        FROM
        wf_item_node_define
        WHERE
        id IN (
        SELECT DISTINCT
        nodeid
        FROM
        wf_instance
        WHERE
        id IN (
        SELECT
        wf_instance_id
        FROM
        biz_item_apply
        WHERE
        itemid IN (
        SELECT
        itemid
        FROM
        biz_org_items
        WHERE
        orgid = (
        SELECT
        orgid
        FROM
        biz_org_users
        WHERE
        userid = #{userId}
        )
        AND `status` = 2
        )
        AND `status` = 3
        AND wf_instance_id != 0
        )
        )
        AND audit_userid LIKE CONCAT('%',#{userId},'%')
        )
        )
        AND itemapply.`status` = 3
        <if test="itemId != null">
            AND itemapply.itemid = #{itemId}
        </if>
        order by createdDate desc
    </select>
    <select id="dealList" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date AS submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName
        FROM
        biz_item_apply AS itemapply
        INNER JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        WHERE
        itemapply.wf_instance_id IN (
        SELECT
        instid
        FROM
        `wf_inst_audit_track`
        WHERE
        userid = #{userId}
        )
        <if test="itemId != null">
            AND itemapply.itemid = #{itemId}
        </if>
        order by createdDate desc
    </select>
    <update id="updateState" parameterType="java.util.Map">
        UPDATE biz_item_apply
        SET `status` = #{state}
        WHERE
            `applyid` = #{applyid}
    </update>
    <select id="history" parameterType="java.lang.Integer" resultType="com.dm.user.entity.ApplyHistory">
        SELECT
            ucuser.`username` AS `username`,
            audit.`audit_date` AS `auditDate`,
            audit.`status` AS `status`,
            audit.`reason` AS `reason`,
            certfile.`file_url` AS `fileUrl`
        FROM
            wf_inst_audit_track AS audit
        LEFT JOIN `biz_item_apply` AS apply ON apply.wf_instance_id = audit.instid
        LEFT JOIN uc_user AS ucuser ON ucuser.userid = audit.userid
        LEFT JOIN biz_cert_files AS certfile ON certfile.file_id = audit.fileid
        WHERE
            apply.applyid = #{applyid}
        ORDER BY auditDate DESC
    </select>
</mapper>