<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dm.user.mapper.ItemApplyMapper">
    <resultMap id="BaseResultMap" type="com.dm.user.entity.ItemApply">
        <id column="applyid" jdbcType="INTEGER" property="applyid"/>
        <result column="apply_no" jdbcType="VARCHAR" property="applyNo"/>
        <result column="itemid" jdbcType="INTEGER" property="itemid"/>
        <result column="userid" jdbcType="INTEGER" property="userid"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="describe" jdbcType="VARCHAR" property="describe"/>
        <result column="certid" jdbcType="INTEGER" property="certid"/>
        <result column="created_date" jdbcType="TIMESTAMP" property="createdDate"/>
        <result column="submit_date" jdbcType="TIMESTAMP" property="submitDate"/>
        <result column="item_value" jdbcType="DECIMAL" property="itemValue"/>
        <result column="price" jdbcType="DECIMAL" property="price"/>
        <result column="wf_instance_id" jdbcType="VARCHAR" property="wfInstanceId"/>
        <result column="handle_created_date" jdbcType="TIMESTAMP" property="handleCreatedDate"/>
        <result column="handle_userid" jdbcType="INTEGER" property="handleUserid"/>
        <result column="pay_status" jdbcType="INTEGER" property="payStatus"/>
        <result column="pay_end_price" jdbcType="DECIMAL" property="payEndPrice"/>
        <result column="item_code" jdbcType="VARCHAR" property="itemCode"/>
    </resultMap>
    <sql id="Base_Column_List">
    applyid, apply_no, itemid, userid, `status`, `describe`, certid, created_date, submit_date,
    item_value, price, wf_instance_id, handle_created_date, handle_userid, pay_status, pay_end_price, item_code
  </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from biz_item_apply
        where applyid = #{applyid,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from biz_item_apply
    where applyid = #{applyid,jdbcType=INTEGER}
  </delete>
    <insert id="insertSelective" parameterType="com.dm.user.entity.ItemApply" useGeneratedKeys="true"
            keyProperty="applyid">
        insert into biz_item_apply
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="applyNo != null">
                apply_no,
            </if>
            <if test="itemid != null">
                itemid,
            </if>
            <if test="userid != null">
                userid,
            </if>
            <if test="status != null">
                `status`,
            </if>
            <if test="describe != null">
                `describe`,
            </if>
            <if test="certid != null">
                certid,
            </if>
            <if test="createdDate != null">
                created_date,
            </if>
            <if test="submitDate != null">
                submit_date,
            </if>
            <if test="itemValue != null">
                item_value,
            </if>
            <if test="price != null">
                price,
            </if>
            <if test="wfInstanceId != null">
                wf_instance_id,
            </if>
            <if test="handleCreatedDate != null">
                handle_created_date,
            </if>
            <if test="handleUserid != null">
                handle_userid,
            </if>
            <if test="payStatus != null">
                pay_status,
            </if>
            <if test="payEndPrice != null">
                pay_end_price,
            </if>
            <if test="itemCode != null">
                item_code,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="applyNo != null">
                #{applyNo,jdbcType=VARCHAR},
            </if>
            <if test="itemid != null">
                #{itemid,jdbcType=INTEGER},
            </if>
            <if test="userid != null">
                #{userid,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="describe != null">
                #{describe,jdbcType=VARCHAR},
            </if>
            <if test="certid != null">
                #{certid,jdbcType=INTEGER},
            </if>
            <if test="createdDate != null">
                #{createdDate,jdbcType=TIMESTAMP},
            </if>
            <if test="submitDate != null">
                #{submitDate,jdbcType=TIMESTAMP},
            </if>
            <if test="itemValue != null">
                #{itemValue,jdbcType=DECIMAL},
            </if>
            <if test="price != null">
                #{price,jdbcType=DECIMAL},
            </if>
            <if test="wfInstanceId != null">
                #{wfInstanceId,jdbcType=VARCHAR},
            </if>
            <if test="handleCreatedDate != null">
                #{handleCreatedDate,jdbcType=TIMESTAMP},
            </if>
            <if test="handleUserid != null">
                #{handleUserid,jdbcType=INTEGER},
            </if>
            <if test="payStatus != null">
                #{payStatus,jdbcType=INTEGER},
            </if>
            <if test="payEndPrice != null">
                #{payEndPrice,jdbcType=DECIMAL},
            </if>
            <if test="itemCode != null">
                #{itemCode,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.dm.user.entity.ItemApply">
        update biz_item_apply
        <set>
            <if test="applyNo != null">
                apply_no = #{applyNo,jdbcType=VARCHAR},
            </if>
            <if test="itemid != null">
                itemid = #{itemid,jdbcType=INTEGER},
            </if>
            <if test="userid != null">
                userid = #{userid,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                `status` = #{status,jdbcType=INTEGER},
            </if>
            <if test="describe != null">
                `describe` = #{describe,jdbcType=VARCHAR},
            </if>
            <if test="certid != null">
                certid = #{certid,jdbcType=INTEGER},
            </if>
            <if test="createdDate != null">
                created_date = #{createdDate,jdbcType=TIMESTAMP},
            </if>
            <if test="submitDate != null">
                submit_date = #{submitDate,jdbcType=TIMESTAMP},
            </if>
            <if test="itemValue != null">
                item_value = #{itemValue,jdbcType=DECIMAL},
            </if>
            <if test="price != null">
                price = #{price,jdbcType=DECIMAL},
            </if>
            <if test="wfInstanceId != null">
                wf_instance_id = #{wfInstanceId,jdbcType=VARCHAR},
            </if>
            <if test="handleCreatedDate != null">
                handle_created_date = #{handleCreatedDate,jdbcType=TIMESTAMP},
            </if>
            <if test="handleUserid != null">
                handle_userid = #{handleUserid,jdbcType=INTEGER},
            </if>
            <if test="payStatus != null">
                pay_status = #{payStatus,jdbcType=INTEGER},
            </if>
            <if test="payEndPrice != null">
                pay_end_price = #{payEndPrice,jdbcType=DECIMAL},
            </if>
            <if test="itemCode != null">
                item_code = #{itemCode,jdbcType=VARCHAR},
            </if>
        </set>
        where applyid = #{applyid,jdbcType=INTEGER}
    </update>
    <select id="list" parameterType="java.lang.Integer" resultType="com.dm.user.entity.ItemApply">
        SELECT
	    itemapply.applyid AS applyid,
	    itemapply.apply_no AS applyNo,
    	itemapply.certid AS certid,
    	itemapply.created_date AS createdDate,
    	itemapply.submit_date AS submitDate,
    	itemapply.`describe` AS `describe`,
	    itemapply.itemid AS itemid,
	    itemapply.item_value AS itemValue,
	    itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        orgitem.logo_url AS logoUrl
        FROM
            biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        WHERE
            userid = #{userid,jdbcType=INTEGER}
        ORDER BY
	    submitDate DESC , createdDate DESC
    </select>
    <select id="pendList" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date as submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName,
        orgitem.logo_url AS logoUrl
        FROM biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        where 1 = 1
        <if test="itemId != null and itemId != '' ">
            and itemapply.itemid = #{itemId}
        </if>
        and itemapply.`status` = #{status}
        and itemapply.handle_userid = 0
        and itemapply.handle_created_date is null
        group by itemapply.applyid
        order by createdDate desc
    </select>
    <select id="pendReview" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date as submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName,
        orgitem.logo_url AS logoUrl
        FROM biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        where 1=1
        <if test="itemId != null and itemId != '' ">
            and itemapply.itemid = #{itemId}
        </if>
        <if test="status!=null and status.length!=0">
            and itemapply.`status` in
            <foreach collection="status" item="state" open="(" close=")" separator=",">
                #{state}
            </foreach>
        </if>
        and itemapply.handle_userid = #{userId}
        order by submitDate desc
    </select>
    <select id="selectWaitList" parameterType="java.lang.String" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date AS submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName,
        orgitem.logo_url AS logoUrl
        FROM
        biz_item_apply AS itemapply
        LEFT JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (
        itemapply.userid = usercard.userid
        AND (
        usercard.real_state = 2
        OR usercard.real_state = 3
        )
        )
        WHERE
        itemapply.pay_status = #{payStatus}
        AND itemapply.`status` = #{status}
        AND itemapply.wf_instance_id IN (
        SELECT
        id
        FROM
        wf_instance
        WHERE
        nodeid IN (
        SELECT
        id
        FROM
        wf_item_node_define
        WHERE
        audit_userid LIKE CONCAT('%',#{userId},'%')
        )
        )
        <if test="itemId != null">
            AND itemapply.itemid = #{itemId}
        </if>
        group by itemapply.applyid
        order by submitDate desc
    </select>
    <select id="dealList" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.certid AS certid,
        itemapply.created_date AS createdDate,
        itemapply.submit_date AS submitDate,
        itemapply.`describe` AS `describe`,
        itemapply.itemid AS itemid,
        itemapply.item_value AS itemValue,
        itemapply.price AS price,
        itemapply.`status` AS `status`,
        itemapply.userid AS userid,
        itemapply.wf_instance_id AS wfInstanceId,
        orgitem.item_name AS itemName,
        usercard.real_name AS realName,
        orgitem.logo_url AS logoUrl
        FROM
        `wf_inst_audit_track` AS track
        LEFT JOIN
        biz_item_apply AS itemapply ON track.instid = itemapply.wf_instance_id
        INNER JOIN biz_org_items AS orgitem ON itemapply.itemid = orgitem.itemid
        LEFT JOIN sys_user_card usercard ON (itemapply.userid = usercard.userid
        AND usercard.real_state = 2)
        WHERE
        itemapply.wf_instance_id IN (
        SELECT
        instid
        FROM
        `wf_inst_audit_track`
        WHERE
        userid = #{userId}
        )
        <if test="itemId != null">
            AND itemapply.itemid = #{itemId}
        </if>
        group by itemapply.applyid
        order by createdDate desc
    </select>
    <update id="updateState" parameterType="java.util.Map">
        UPDATE biz_item_apply
        SET `status` = #{state}
        WHERE
            `applyid` = #{applyid}
    </update>
    <select id="history" parameterType="java.lang.Integer" resultType="com.dm.user.entity.ApplyHistory">
        SELECT
            ucuser.`username` AS `username`,
            audit.`audit_date` AS `auditDate`,
            audit.`status` AS `status`,
            audit.`reason` AS `reason`,
            certfile.`file_url` AS `fileUrl`
        FROM
            wf_inst_audit_track AS audit
        LEFT JOIN `biz_item_apply` AS apply ON apply.wf_instance_id = audit.instid
        LEFT JOIN uc_user AS ucuser ON ucuser.userid = audit.userid
        LEFT JOIN biz_cert_files AS certfile ON certfile.file_id = audit.fileid
        WHERE
            apply.applyid = #{applyid}
        ORDER BY auditDate DESC
    </select>
    <select id="selectOrderCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            biz_item_apply
        WHERE
            `status` = #{status}
        AND handle_userid = 0
    </select>
    <select id="inProcessing" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        biz_item_apply AS itemapply
        WHERE
        1 = 1
        AND itemapply.`status` IN
        <foreach collection="inProcessing" open="(" separator="," close=")" item="s">
            #{s}
        </foreach>
        AND itemapply.handle_userid = #{userId}
    </select>
    <select id="isProcessing" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        biz_item_apply AS itemapply
        WHERE
        1 = 1
        AND itemapply.`status` IN
        <foreach collection="isProcessing" open="(" separator="," close=")" item="s">
            #{s}
        </foreach>
        AND itemapply.handle_userid = #{userId}
    </select>
    <select id="selectMyApply" parameterType="java.util.Map" resultType="com.dm.user.entity.ItemApply">
        SELECT
        itemapply.applyid AS applyid,
        itemapply.apply_no AS applyNo,
        itemapply.created_date AS createdDate,
        itemapply.`status` AS `status`,
        item.item_name AS itemName,
        item.logo_url AS logoUrl,
        item.itemid AS itemid
        FROM
        biz_item_apply itemapply
        LEFT JOIN biz_org_items item
        ON itemapply.itemid = item.itemid
        WHERE
        itemapply.userid = #{userId}
        GROUP BY itemapply.applyid
        ORDER BY
        itemapply.created_date DESC
        LIMIT 3
    </select>
    <select id="selectNewApply" parameterType="java.lang.Integer" resultType="com.dm.user.entity.ItemApply">
        SELECT
            itemapply.applyid AS applyid,
            itemapply.apply_no AS applyNo,
            itemapply.submit_date AS submitDate,
            itemapply.`status` AS `status`,
            item.item_name AS itemName,
            item.logo_url AS logoUrl,
            item.itemid AS itemid
        FROM
            biz_item_apply itemapply
        LEFT JOIN biz_org_items item ON itemapply.itemid = item.itemid
        WHERE
            itemapply.`status` = #{status}
            AND itemapply.handle_userid = 0
        GROUP BY
            itemapply.applyid
        ORDER BY
            itemapply.submit_date DESC
        LIMIT 3
    </select>
    <select id="selectWaitApplyCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
            biz_item_apply AS itemapply
        WHERE
            itemapply.pay_status = #{payStatus}
        AND itemapply.`status` = #{status}
        AND itemapply.wf_instance_id IN (
            SELECT
                id
            FROM
                wf_instance
            WHERE
                nodeid IN (
                    SELECT
                        id
                    FROM
                        wf_item_node_define
                    WHERE
                        audit_userid LIKE CONCAT('%',#{userId},'%')
                )
        )
    </select>
    <select id="selectMyApplyCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        select
        count(1)
        from biz_item_apply
        where userid = #{userId}
    </select>
</mapper>